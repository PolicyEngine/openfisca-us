Traceback (most recent call last):
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/jupyter_cache/executors/utils.py", line 58, in single_nb_execution
    executenb(
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 1305, in execute
    return NotebookClient(nb=nb, resources=resources, km=km, **kwargs).execute()
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/jupyter_core/utils/__init__.py", line 166, in wrapped
    return loop.run_until_complete(inner)
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/asyncio/base_events.py", line 647, in run_until_complete
    return future.result()
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 705, in async_execute
    await self.async_execute_cell(
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 1058, in async_execute_cell
    await self._check_raise_for_error(cell, cell_index, exec_reply)
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 914, in _check_raise_for_error
    raise CellExecutionError.from_cell_and_msg(cell, exec_reply_content)
nbclient.exceptions.CellExecutionError: An error occurred while executing the following cell:
------------------
from policyengine_us import IndividualSim
from policyengine_us.model_api import *
import pandas as pd
import plotly.express as px

LIGHT_GRAY = "#F5F5F5"
GRAY = "#BDBDBD"
BLUE = "#5091cc"
LIGHT_BLUE = "lightblue"
DARK_BLUE = "darkblue"

COLOR_MAP = {"0": GRAY, "1": LIGHT_BLUE, "2": BLUE, "3": DARK_BLUE}


def make_net_income(adults, children, year, reform):
    if reform is None:
        sim = IndividualSim(year=year)
    else:
        sim = IndividualSim(reform, year=year)
    sim.add_person(name="head", age=25)
    members = ["head"]
    if adults == 2:
        sim.add_person(name="spouse")
        members += ["spouse"]
    for i in range(children):
        child = "child{}".format(i)
        sim.add_person(name=child, age=6)
        members += [child]
    sim.add_tax_unit(name="tax_unit", members=members)
    sim.add_household(name="household", members=members)
    sim.vary("employment_income", max=200_000, step=1_000)
    return pd.DataFrame(
        dict(
            employment_income=sim.calc("employment_income")[0],
            income_tax=sim.calc("income_tax"),
        )
    )


class neutralize_ctc(Reform):
    def apply(self):
        self.neutralize_variable("ctc")


def get_ctc_impact(adults, children, year):
    baseline = make_net_income(adults, children, year, None)
    reform = make_net_income(adults, children, year, neutralize_ctc)
    return pd.DataFrame(
        dict(
            adults=adults,
            children=children,
            year=year,
            employment_income=baseline.employment_income,
            baseline=baseline.income_tax,
            reform=reform.income_tax,
            ctc=reform.income_tax - baseline.income_tax,
        )
    )


# Make a table of CTC amounts for different numbers of adults and children.
l = []
for adults in range(1, 3):
    for children in range(0, 4):
        for year in [2020, 2021, 2022]:
            l.append(get_ctc_impact(adults, children, year))

df = pd.concat(l)

LABELS = dict(
    employment_income="Employment income",
    income_source="Income source",
    ctc="Child tax credit",
    mtr="CTC marginal tax rate",
    children="Children",
    adults="Adults",
)

fig = px.line(
    df,
    "employment_income",
    "ctc",
    color="children",
    facet_col="adults",
    animation_frame="year",
    labels=LABELS,
    title="Child tax credit",
    color_discrete_map=COLOR_MAP,
)

fig.update_layout(
    xaxis_tickformat="$,",
    yaxis_tickformat="$,",
    plot_bgcolor="white",
    xaxis_gridcolor=LIGHT_GRAY,
    yaxis_gridcolor=LIGHT_GRAY,
)
fig.show()
------------------


[0;31m---------------------------------------------------------------------------[0m
[0;31mValueError[0m                                Traceback (most recent call last)
File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/individual_sim.py:261[0m, in [0;36mIndividualSim.calc[0;34m(self, var, period, target, index, map_to, reform)[0m
[1;32m    260[0m [38;5;28;01mtry[39;00m:
[0;32m--> 261[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m[43mvar[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    262[0m [38;5;28;01mexcept[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:732[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    731[0m [38;5;28;01mif[39;00m formula[38;5;241m.[39m[38;5;18m__code__[39m[38;5;241m.[39mco_argcount [38;5;241m==[39m [38;5;241m2[39m:
[0;32m--> 732[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    733[0m [38;5;28;01melse[39;00m:

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/tools/general.py:45[0m, in [0;36mvariable_alias.<locals>.<lambda>[0;34m(entity, period)[0m
[1;32m     44[0m class_dict [38;5;241m=[39m [38;5;28mdict[39m(variable_cls[38;5;241m.[39m[38;5;18m__dict__[39m)
[0;32m---> 45[0m class_dict[[38;5;124m"[39m[38;5;124mformula[39m[38;5;124m"[39m] [38;5;241m=[39m [38;5;28;01mlambda[39;00m entity, period: [43mentity[49m[43m([49m
[1;32m     46[0m [43m    [49m[43mvariable_cls[49m[38;5;241;43m.[39;49m[38;5;18;43m__name__[39;49m[43m,[49m[43m [49m[43mperiod[49m
[1;32m     47[0m [43m[49m[43m)[49m
[1;32m     48[0m [38;5;28;01mreturn[39;00m [38;5;28mtype[39m(
[1;32m     49[0m     name,
[1;32m     50[0m     variable_cls[38;5;241m.[39m[38;5;18m__bases__[39m,
[1;32m     51[0m     class_dict,
[1;32m     52[0m )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/tax/federal_income/income_tax.py:28[0m, in [0;36miitax.formula[0;34m(person, period, parameters)[0m
[1;32m     27[0m [38;5;28;01melse[39;00m:
[0;32m---> 28[0m     added_components [38;5;241m=[39m [43madd[49m[43m([49m[43mperson[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43miitax[49m[38;5;241;43m.[39;49m[43madds[49m[43m)[49m
[1;32m     29[0m     subtracted_components [38;5;241m=[39m add(person, period, iitax[38;5;241m.[39msubtracts)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    209[0m [38;5;250m[39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03mArgs:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m    ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m"""[39;00m
[0;32m--> 223[0m [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m    [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/tax/federal_income/before_credits/income_tax_main_rates.py:14[0m, in [0;36mincome_tax_main_rates.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     12[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[1;32m     13[0m     [38;5;66;03m# compute taxable income that is taxed at the main rates[39;00m
[0;32m---> 14[0m     full_taxable_income [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mtaxable_income[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     15[0m     cg_exclusion [38;5;241m=[39m tax_unit(
[1;32m     16[0m         [38;5;124m"[39m[38;5;124mcapital_gains_excluded_from_taxable_income[39m[38;5;124m"[39m, period
[1;32m     17[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/income/taxable_income/taxable_income.py:13[0m, in [0;36mtaxable_income.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     12[0m agi [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124madjusted_gross_income[39m[38;5;124m"[39m, period)
[0;32m---> 13[0m deductions [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mtaxable_income_deductions[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     14[0m [38;5;28;01mreturn[39;00m max_([38;5;241m0[39m, agi [38;5;241m-[39m deductions)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/income/taxable_income/deductions/taxable_income_deductions.py:13[0m, in [0;36mtaxable_income_deductions.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     12[0m itemizes [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mtax_unit_itemizes[39m[38;5;124m"[39m, period)
[0;32m---> 13[0m deductions_if_itemizing [38;5;241m=[39m [43mtax_unit[49m[43m([49m
[1;32m     14[0m [43m    [49m[38;5;124;43m"[39;49m[38;5;124;43mtaxable_income_deductions_if_itemizing[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m
[1;32m     15[0m [43m[49m[43m)[49m
[1;32m     16[0m deductions_if_not_itemizing [38;5;241m=[39m tax_unit(
[1;32m     17[0m     [38;5;124m"[39m[38;5;124mtaxable_income_deductions_if_not_itemizing[39m[38;5;124m"[39m, period
[1;32m     18[0m )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/income/taxable_income/deductions/itemizing/salt_deduction.py:14[0m, in [0;36msalt_deduction.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     13[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[0;32m---> 14[0m     salt_amount [38;5;241m=[39m [43madd[49m[43m([49m
[1;32m     15[0m [43m        [49m[43mtax_unit[49m[43m,[49m
[1;32m     16[0m [43m        [49m[43mperiod[49m[43m,[49m
[1;32m     17[0m [43m        [49m[43m[[49m[38;5;124;43m"[39;49m[38;5;124;43mstate_and_local_sales_or_income_tax[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[38;5;124;43m"[39;49m[38;5;124;43mreal_estate_taxes[39;49m[38;5;124;43m"[39;49m[43m][49m[43m,[49m
[1;32m     18[0m [43m    [49m[43m)[49m
[1;32m     19[0m     salt [38;5;241m=[39m parameters(
[1;32m     20[0m         period
[1;32m     21[0m     )[38;5;241m.[39mgov[38;5;241m.[39mirs[38;5;241m.[39mdeductions[38;5;241m.[39mitemized[38;5;241m.[39msalt_and_real_estate

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    209[0m [38;5;250m[39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03mArgs:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m    ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m"""[39;00m
[0;32m--> 223[0m [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m    [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/taxcalc/deductions/itemized/state_and_local_sales_or_income_tax.py:13[0m, in [0;36mstate_and_local_sales_or_income_tax.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     11[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[1;32m     12[0m     [38;5;66;03m# Only sales or income tax can be itemized, but not both.[39;00m
[0;32m---> 13[0m     income_tax [38;5;241m=[39m [43madd[49m[43m([49m
[1;32m     14[0m [43m        [49m[43mtax_unit[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43m[[49m[38;5;124;43m"[39;49m[38;5;124;43mstate_income_tax[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[38;5;124;43m"[39;49m[38;5;124;43mlocal_income_tax[39;49m[38;5;124;43m"[39;49m[43m][49m
[1;32m     15[0m [43m    [49m[43m)[49m
[1;32m     16[0m     sales_tax [38;5;241m=[39m add(
[1;32m     17[0m         tax_unit, period, [[38;5;124m"[39m[38;5;124mstate_sales_tax[39m[38;5;124m"[39m, [38;5;124m"[39m[38;5;124mlocal_sales_tax[39m[38;5;124m"[39m]
[1;32m     18[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    209[0m [38;5;250m[39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03mArgs:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m    ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m"""[39;00m
[0;32m--> 223[0m [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m    [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/tax/income/state_income_tax.py:44[0m, in [0;36mstate_income_tax.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     43[0m [38;5;28;01melse[39;00m:
[0;32m---> 44[0m     [38;5;28;01mreturn[39;00m [43madd[49m[43m([49m[43mtax_unit[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mstate_income_tax[49m[38;5;241;43m.[39;49m[43madds[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    209[0m [38;5;250m[39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03mArgs:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m    ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m"""[39;00m
[0;32m--> 223[0m [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m    [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/ca/tax/income/ca_income_tax_before_refundable_credits.py:14[0m, in [0;36mca_income_tax_before_refundable_credits.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     13[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[0;32m---> 14[0m     itax [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mca_income_tax_before_credits[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     15[0m     nonrefundable_credits [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mca_nonrefundable_credits[39m[38;5;124m"[39m, period)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/ca/tax/income/ca_income_tax_before_credits.py:15[0m, in [0;36mca_income_tax_before_credits.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     14[0m filing_status [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mfiling_status[39m[38;5;124m"[39m, period)
[0;32m---> 15[0m taxable_income [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mca_taxable_income[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     16[0m p [38;5;241m=[39m parameters(period)[38;5;241m.[39mgov[38;5;241m.[39mstates[38;5;241m.[39mca[38;5;241m.[39mtax[38;5;241m.[39mincome[38;5;241m.[39mrates

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/ca/tax/income/ca_taxable_income.py:19[0m, in [0;36mca_taxable_income.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     18[0m p [38;5;241m=[39m parameters(period)[38;5;241m.[39mgov[38;5;241m.[39mstates[38;5;241m.[39mca[38;5;241m.[39mtax[38;5;241m.[39mincome
[0;32m---> 19[0m std_ded [38;5;241m=[39m [43mp[49m[38;5;241;43m.[39;49m[43mdeductions[49m[38;5;241;43m.[39;49m[43mstandard[49m[38;5;241;43m.[39;49m[43mamount[49m[43m[[49m[43mfiling_status[49m[43m][49m
[1;32m     20[0m itm_ded [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mca_itemized_deductions[39m[38;5;124m"[39m, period)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/parameters/parameter_node_at_instant.py:58[0m, in [0;36mParameterNodeAtInstant.__getitem__[0;34m(self, key)[0m
[1;32m     57[0m [38;5;28;01mif[39;00m [38;5;28misinstance[39m(key, numpy[38;5;241m.[39mndarray):
[0;32m---> 58[0m     [38;5;28;01mreturn[39;00m [43mparameters[49m[38;5;241;43m.[39;49m[43mVectorialParameterNodeAtInstant[49m[38;5;241;43m.[39;49m[43mbuild_from_node[49m[43m([49m
[1;32m     59[0m [43m        [49m[38;5;28;43mself[39;49m
[1;32m     60[0m [43m    [49m[43m)[49m[43m[[49m[43mkey[49m[43m][49m
[1;32m     61[0m [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39m_children[key]

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/parameters/vectorial_parameter_node_at_instant.py:216[0m, in [0;36mVectorialParameterNodeAtInstant.__getitem__[0;34m(self, key)[0m
[1;32m    212[0m names [38;5;241m=[39m [38;5;28mlist[39m(
[1;32m    213[0m     [38;5;28mself[39m[38;5;241m.[39mdtype[38;5;241m.[39mnames
[1;32m    214[0m )  [38;5;66;03m# Get all the names of the subnodes, e.g. ['zone_1', 'zone_2'][39;00m
[1;32m    215[0m default [38;5;241m=[39m numpy[38;5;241m.[39mfull_like(
[0;32m--> 216[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mvector[49m[43m[[49m[43mkey[49m[43m[[49m[38;5;241;43m0[39;49m[43m][49m[43m][49m, numpy[38;5;241m.[39mnan
[1;32m    217[0m )  [38;5;66;03m# In case of unexpected key, we will set the corresponding value to NaN.[39;00m
[1;32m    218[0m conditions [38;5;241m=[39m [key [38;5;241m==[39m name [38;5;28;01mfor[39;00m name [38;5;129;01min[39;00m names]

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/numpy/core/records.py:510[0m, in [0;36mrecarray.__getitem__[0;34m(self, indx)[0m
[1;32m    509[0m [38;5;28;01mdef[39;00m [38;5;21m__getitem__[39m([38;5;28mself[39m, indx):
[0;32m--> 510[0m     obj [38;5;241m=[39m [38;5;28;43msuper[39;49m[43m([49m[43m)[49m[38;5;241;43m.[39;49m[38;5;21;43m__getitem__[39;49m[43m([49m[43mindx[49m[43m)[49m
[1;32m    512[0m     [38;5;66;03m# copy behavior of getattr, except that here[39;00m
[1;32m    513[0m     [38;5;66;03m# we might also be returning a single element[39;00m

[0;31mValueError[0m: no field of name SINGLE

During handling of the above exception, another exception occurred:

[0;31mValueError[0m                                Traceback (most recent call last)
File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/individual_sim.py:264[0m, in [0;36mIndividualSim.calc[0;34m(self, var, period, target, index, map_to, reform)[0m
[1;32m    263[0m [38;5;28;01mtry[39;00m:
[0;32m--> 264[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msim[49m[38;5;241;43m.[39;49m[43mcalculate_add[49m[43m([49m[43mvar[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    265[0m [38;5;28;01mexcept[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:610[0m, in [0;36mSimulation.calculate_add[0;34m(self, variable_name, period, decode_enums)[0m
[1;32m    604[0m     [38;5;28;01mraise[39;00m [38;5;167;01mValueError[39;00m(
[1;32m    605[0m         [38;5;124m"[39m[38;5;124mUnable to sum constant variable [39m[38;5;124m'[39m[38;5;132;01m{}[39;00m[38;5;124m'[39m[38;5;124m over period [39m[38;5;132;01m{}[39;00m[38;5;124m: only variables defined daily, monthly, or yearly can be summed over time.[39m[38;5;124m"[39m[38;5;241m.[39mformat(
[1;32m    606[0m             variable[38;5;241m.[39mname, period
[1;32m    607[0m         )
[1;32m    608[0m     )
[0;32m--> 610[0m [38;5;28;01mreturn[39;00m [38;5;28;43msum[39;49m[43m([49m
[1;32m    611[0m [43m    [49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43msub_period[49m[43m)[49m
[1;32m    612[0m [43m    [49m[38;5;28;43;01mfor[39;49;00m[43m [49m[43msub_period[49m[43m [49m[38;5;129;43;01min[39;49;00m[43m [49m[43mperiod[49m[38;5;241;43m.[39;49m[43mget_subperiods[49m[43m([49m[43mvariable[49m[38;5;241;43m.[39;49m[43mdefinition_period[49m[43m)[49m
[1;32m    613[0m [43m[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:611[0m, in [0;36m<genexpr>[0;34m(.0)[0m
[1;32m    604[0m     [38;5;28;01mraise[39;00m [38;5;167;01mValueError[39;00m(
[1;32m    605[0m         [38;5;124m"[39m[38;5;124mUnable to sum constant variable [39m[38;5;124m'[39m[38;5;132;01m{}[39;00m[38;5;124m'[39m[38;5;124m over period [39m[38;5;132;01m{}[39;00m[38;5;124m: only variables defined daily, monthly, or yearly can be summed over time.[39m[38;5;124m"[39m[38;5;241m.[39mformat(
[1;32m    606[0m             variable[38;5;241m.[39mname, period
[1;32m    607[0m         )
[1;32m    608[0m     )
[1;32m    610[0m [38;5;28;01mreturn[39;00m [38;5;28msum[39m(
[0;32m--> 611[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43msub_period[49m[43m)[49m
[1;32m    612[0m     [38;5;28;01mfor[39;00m sub_period [38;5;129;01min[39;00m period[38;5;241m.[39mget_subperiods(variable[38;5;241m.[39mdefinition_period)
[1;32m    613[0m )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:732[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    731[0m [38;5;28;01mif[39;00m formula[38;5;241m.[39m[38;5;18m__code__[39m[38;5;241m.[39mco_argcount [38;5;241m==[39m [38;5;241m2[39m:
[0;32m--> 732[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    733[0m [38;5;28;01melse[39;00m:

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/tools/general.py:45[0m, in [0;36mvariable_alias.<locals>.<lambda>[0;34m(entity, period)[0m
[1;32m     44[0m class_dict [38;5;241m=[39m [38;5;28mdict[39m(variable_cls[38;5;241m.[39m[38;5;18m__dict__[39m)
[0;32m---> 45[0m class_dict[[38;5;124m"[39m[38;5;124mformula[39m[38;5;124m"[39m] [38;5;241m=[39m [38;5;28;01mlambda[39;00m entity, period: [43mentity[49m[43m([49m
[1;32m     46[0m [43m    [49m[43mvariable_cls[49m[38;5;241;43m.[39;49m[38;5;18;43m__name__[39;49m[43m,[49m[43m [49m[43mperiod[49m
[1;32m     47[0m [43m[49m[43m)[49m
[1;32m     48[0m [38;5;28;01mreturn[39;00m [38;5;28mtype[39m(
[1;32m     49[0m     name,
[1;32m     50[0m     variable_cls[38;5;241m.[39m[38;5;18m__bases__[39m,
[1;32m     51[0m     class_dict,
[1;32m     52[0m )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/tax/federal_income/income_tax.py:28[0m, in [0;36miitax.formula[0;34m(person, period, parameters)[0m
[1;32m     27[0m [38;5;28;01melse[39;00m:
[0;32m---> 28[0m     added_components [38;5;241m=[39m [43madd[49m[43m([49m[43mperson[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43miitax[49m[38;5;241;43m.[39;49m[43madds[49m[43m)[49m
[1;32m     29[0m     subtracted_components [38;5;241m=[39m add(person, period, iitax[38;5;241m.[39msubtracts)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    209[0m [38;5;250m[39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03mArgs:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m    ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m"""[39;00m
[0;32m--> 223[0m [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m    [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/tax/federal_income/before_credits/income_tax_main_rates.py:14[0m, in [0;36mincome_tax_main_rates.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     12[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[1;32m     13[0m     [38;5;66;03m# compute taxable income that is taxed at the main rates[39;00m
[0;32m---> 14[0m     full_taxable_income [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mtaxable_income[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     15[0m     cg_exclusion [38;5;241m=[39m tax_unit(
[1;32m     16[0m         [38;5;124m"[39m[38;5;124mcapital_gains_excluded_from_taxable_income[39m[38;5;124m"[39m, period
[1;32m     17[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/income/taxable_income/taxable_income.py:13[0m, in [0;36mtaxable_income.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     12[0m agi [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124madjusted_gross_income[39m[38;5;124m"[39m, period)
[0;32m---> 13[0m deductions [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mtaxable_income_deductions[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     14[0m [38;5;28;01mreturn[39;00m max_([38;5;241m0[39m, agi [38;5;241m-[39m deductions)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/income/taxable_income/deductions/taxable_income_deductions.py:13[0m, in [0;36mtaxable_income_deductions.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     12[0m itemizes [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mtax_unit_itemizes[39m[38;5;124m"[39m, period)
[0;32m---> 13[0m deductions_if_itemizing [38;5;241m=[39m [43mtax_unit[49m[43m([49m
[1;32m     14[0m [43m    [49m[38;5;124;43m"[39;49m[38;5;124;43mtaxable_income_deductions_if_itemizing[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m
[1;32m     15[0m [43m[49m[43m)[49m
[1;32m     16[0m deductions_if_not_itemizing [38;5;241m=[39m tax_unit(
[1;32m     17[0m     [38;5;124m"[39m[38;5;124mtaxable_income_deductions_if_not_itemizing[39m[38;5;124m"[39m, period
[1;32m     18[0m )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/income/taxable_income/deductions/itemizing/salt_deduction.py:14[0m, in [0;36msalt_deduction.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     13[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[0;32m---> 14[0m     salt_amount [38;5;241m=[39m [43madd[49m[43m([49m
[1;32m     15[0m [43m        [49m[43mtax_unit[49m[43m,[49m
[1;32m     16[0m [43m        [49m[43mperiod[49m[43m,[49m
[1;32m     17[0m [43m        [49m[43m[[49m[38;5;124;43m"[39;49m[38;5;124;43mstate_and_local_sales_or_income_tax[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[38;5;124;43m"[39;49m[38;5;124;43mreal_estate_taxes[39;49m[38;5;124;43m"[39;49m[43m][49m[43m,[49m
[1;32m     18[0m [43m    [49m[43m)[49m
[1;32m     19[0m     salt [38;5;241m=[39m parameters(
[1;32m     20[0m         period
[1;32m     21[0m     )[38;5;241m.[39mgov[38;5;241m.[39mirs[38;5;241m.[39mdeductions[38;5;241m.[39mitemized[38;5;241m.[39msalt_and_real_estate

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    209[0m [38;5;250m[39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03mArgs:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m    ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m"""[39;00m
[0;32m--> 223[0m [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m    [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/taxcalc/deductions/itemized/state_and_local_sales_or_income_tax.py:13[0m, in [0;36mstate_and_local_sales_or_income_tax.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     11[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[1;32m     12[0m     [38;5;66;03m# Only sales or income tax can be itemized, but not both.[39;00m
[0;32m---> 13[0m     income_tax [38;5;241m=[39m [43madd[49m[43m([49m
[1;32m     14[0m [43m        [49m[43mtax_unit[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43m[[49m[38;5;124;43m"[39;49m[38;5;124;43mstate_income_tax[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[38;5;124;43m"[39;49m[38;5;124;43mlocal_income_tax[39;49m[38;5;124;43m"[39;49m[43m][49m
[1;32m     15[0m [43m    [49m[43m)[49m
[1;32m     16[0m     sales_tax [38;5;241m=[39m add(
[1;32m     17[0m         tax_unit, period, [[38;5;124m"[39m[38;5;124mstate_sales_tax[39m[38;5;124m"[39m, [38;5;124m"[39m[38;5;124mlocal_sales_tax[39m[38;5;124m"[39m]
[1;32m     18[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    209[0m [38;5;250m[39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03mArgs:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m    ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m"""[39;00m
[0;32m--> 223[0m [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m    [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/tax/income/state_income_tax.py:44[0m, in [0;36mstate_income_tax.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     43[0m [38;5;28;01melse[39;00m:
[0;32m---> 44[0m     [38;5;28;01mreturn[39;00m [43madd[49m[43m([49m[43mtax_unit[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mstate_income_tax[49m[38;5;241;43m.[39;49m[43madds[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    209[0m [38;5;250m[39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03mArgs:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m    ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m"""[39;00m
[0;32m--> 223[0m [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m    [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/ca/tax/income/ca_income_tax_before_refundable_credits.py:14[0m, in [0;36mca_income_tax_before_refundable_credits.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     13[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[0;32m---> 14[0m     itax [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mca_income_tax_before_credits[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     15[0m     nonrefundable_credits [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mca_nonrefundable_credits[39m[38;5;124m"[39m, period)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/ca/tax/income/ca_income_tax_before_credits.py:15[0m, in [0;36mca_income_tax_before_credits.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     14[0m filing_status [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mfiling_status[39m[38;5;124m"[39m, period)
[0;32m---> 15[0m taxable_income [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mca_taxable_income[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     16[0m p [38;5;241m=[39m parameters(period)[38;5;241m.[39mgov[38;5;241m.[39mstates[38;5;241m.[39mca[38;5;241m.[39mtax[38;5;241m.[39mincome[38;5;241m.[39mrates

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    490[0m [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m [38;5;66;03m# If no result, use the default value and cache it[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/ca/tax/income/ca_taxable_income.py:19[0m, in [0;36mca_taxable_income.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     18[0m p [38;5;241m=[39m parameters(period)[38;5;241m.[39mgov[38;5;241m.[39mstates[38;5;241m.[39mca[38;5;241m.[39mtax[38;5;241m.[39mincome
[0;32m---> 19[0m std_ded [38;5;241m=[39m [43mp[49m[38;5;241;43m.[39;49m[43mdeductions[49m[38;5;241;43m.[39;49m[43mstandard[49m[38;5;241;43m.[39;49m[43mamount[49m[43m[[49m[43mfiling_status[49m[43m][49m
[1;32m     20[0m itm_ded [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mca_itemized_deductions[39m[38;5;124m"[39m, period)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/parameters/parameter_node_at_instant.py:58[0m, in [0;36mParameterNodeAtInstant.__getitem__[0;34m(self, key)[0m
[1;32m     57[0m [38;5;28;01mif[39;00m [38;5;28misinstance[39m(key, numpy[38;5;241m.[39mndarray):
[0;32m---> 58[0m     [38;5;28;01mreturn[39;00m [43mparameters[49m[38;5;241;43m.[39;49m[43mVectorialParameterNodeAtInstant[49m[38;5;241;43m.[39;49m[43mbuild_from_node[49m[43m([49m
[1;32m     59[0m [43m        [49m[38;5;28;43mself[39;49m
[1;32m     60[0m [43m    [49m[43m)[49m[43m[[49m[43mkey[49m[43m][49m
[1;32m     61[0m [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39m_children[key]

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/parameters/vectorial_parameter_node_at_instant.py:216[0m, in [0;36mVectorialParameterNodeAtInstant.__getitem__[0;34m(self, key)[0m
[1;32m    212[0m names [38;5;241m=[39m [38;5;28mlist[39m(
[1;32m    213[0m     [38;5;28mself[39m[38;5;241m.[39mdtype[38;5;241m.[39mnames
[1;32m    214[0m )  [38;5;66;03m# Get all the names of the subnodes, e.g. ['zone_1', 'zone_2'][39;00m
[1;32m    215[0m default [38;5;241m=[39m numpy[38;5;241m.[39mfull_like(
[0;32m--> 216[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mvector[49m[43m[[49m[43mkey[49m[43m[[49m[38;5;241;43m0[39;49m[43m][49m[43m][49m, numpy[38;5;241m.[39mnan
[1;32m    217[0m )  [38;5;66;03m# In case of unexpected key, we will set the corresponding value to NaN.[39;00m
[1;32m    218[0m conditions [38;5;241m=[39m [key [38;5;241m==[39m name [38;5;28;01mfor[39;00m name [38;5;129;01min[39;00m names]

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/numpy/core/records.py:510[0m, in [0;36mrecarray.__getitem__[0;34m(self, indx)[0m
[1;32m    509[0m [38;5;28;01mdef[39;00m [38;5;21m__getitem__[39m([38;5;28mself[39m, indx):
[0;32m--> 510[0m     obj [38;5;241m=[39m [38;5;28;43msuper[39;49m[43m([49m[43m)[49m[38;5;241;43m.[39;49m[38;5;21;43m__getitem__[39;49m[43m([49m[43mindx[49m[43m)[49m
[1;32m    512[0m     [38;5;66;03m# copy behavior of getattr, except that here[39;00m
[1;32m    513[0m     [38;5;66;03m# we might also be returning a single element[39;00m

[0;31mValueError[0m: no field of name SINGLE

During handling of the above exception, another exception occurred:

[0;31mValueError[0m                                Traceback (most recent call last)
Cell [0;32mIn[4], line 66[0m
[1;32m     64[0m     [38;5;28;01mfor[39;00m children [38;5;129;01min[39;00m [38;5;28mrange[39m([38;5;241m0[39m, [38;5;241m4[39m):
[1;32m     65[0m         [38;5;28;01mfor[39;00m year [38;5;129;01min[39;00m [[38;5;241m2020[39m, [38;5;241m2021[39m, [38;5;241m2022[39m]:
[0;32m---> 66[0m             l[38;5;241m.[39mappend([43mget_ctc_impact[49m[43m([49m[43madults[49m[43m,[49m[43m [49m[43mchildren[49m[43m,[49m[43m [49m[43myear[49m[43m)[49m)
[1;32m     68[0m df [38;5;241m=[39m pd[38;5;241m.[39mconcat(l)
[1;32m     70[0m LABELS [38;5;241m=[39m [38;5;28mdict[39m(
[1;32m     71[0m     employment_income[38;5;241m=[39m[38;5;124m"[39m[38;5;124mEmployment income[39m[38;5;124m"[39m,
[1;32m     72[0m     income_source[38;5;241m=[39m[38;5;124m"[39m[38;5;124mIncome source[39m[38;5;124m"[39m,
[0;32m   (...)[0m
[1;32m     76[0m     adults[38;5;241m=[39m[38;5;124m"[39m[38;5;124mAdults[39m[38;5;124m"[39m,
[1;32m     77[0m )

Cell [0;32mIn[4], line 46[0m, in [0;36mget_ctc_impact[0;34m(adults, children, year)[0m
[1;32m     45[0m [38;5;28;01mdef[39;00m [38;5;21mget_ctc_impact[39m(adults, children, year):
[0;32m---> 46[0m     baseline [38;5;241m=[39m [43mmake_net_income[49m[43m([49m[43madults[49m[43m,[49m[43m [49m[43mchildren[49m[43m,[49m[43m [49m[43myear[49m[43m,[49m[43m [49m[38;5;28;43;01mNone[39;49;00m[43m)[49m
[1;32m     47[0m     reform [38;5;241m=[39m make_net_income(adults, children, year, neutralize_ctc)
[1;32m     48[0m     [38;5;28;01mreturn[39;00m pd[38;5;241m.[39mDataFrame(
[1;32m     49[0m         [38;5;28mdict[39m(
[1;32m     50[0m             adults[38;5;241m=[39madults,
[0;32m   (...)[0m
[1;32m     57[0m         )
[1;32m     58[0m     )

Cell [0;32mIn[4], line 35[0m, in [0;36mmake_net_income[0;34m(adults, children, year, reform)[0m
[1;32m     30[0m sim[38;5;241m.[39madd_household(name[38;5;241m=[39m[38;5;124m"[39m[38;5;124mhousehold[39m[38;5;124m"[39m, members[38;5;241m=[39mmembers)
[1;32m     31[0m sim[38;5;241m.[39mvary([38;5;124m"[39m[38;5;124memployment_income[39m[38;5;124m"[39m, [38;5;28mmax[39m[38;5;241m=[39m[38;5;241m200_000[39m, step[38;5;241m=[39m[38;5;241m1_000[39m)
[1;32m     32[0m [38;5;28;01mreturn[39;00m pd[38;5;241m.[39mDataFrame(
[1;32m     33[0m     [38;5;28mdict[39m(
[1;32m     34[0m         employment_income[38;5;241m=[39msim[38;5;241m.[39mcalc([38;5;124m"[39m[38;5;124memployment_income[39m[38;5;124m"[39m)[[38;5;241m0[39m],
[0;32m---> 35[0m         income_tax[38;5;241m=[39m[43msim[49m[38;5;241;43m.[39;49m[43mcalc[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mincome_tax[39;49m[38;5;124;43m"[39;49m[43m)[49m,
[1;32m     36[0m     )
[1;32m     37[0m )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/individual_sim.py:266[0m, in [0;36mIndividualSim.calc[0;34m(self, var, period, target, index, map_to, reform)[0m
[1;32m    264[0m         result [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39msim[38;5;241m.[39mcalculate_add(var, period)
[1;32m    265[0m     [38;5;28;01mexcept[39;00m:
[0;32m--> 266[0m         result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate_divide[49m[43m([49m[43mvar[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    267[0m [38;5;28;01mif[39;00m (
[1;32m    268[0m     target [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m
[1;32m    269[0m     [38;5;129;01mand[39;00m target [38;5;129;01mnot[39;00m [38;5;129;01min[39;00m [38;5;28mself[39m[38;5;241m.[39msituation_data[entity[38;5;241m.[39mplural]
[1;32m    270[0m ):
[1;32m    271[0m     map_to [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mget_entity(target)[38;5;241m.[39mkey

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:647[0m, in [0;36mSimulation.calculate_divide[0;34m(self, variable_name, period, decode_enums)[0m
[1;32m    643[0m     [38;5;28;01mreturn[39;00m (
[1;32m    644[0m         [38;5;28mself[39m[38;5;241m.[39mcalculate(variable_name, period[38;5;241m=[39mcomputation_period) [38;5;241m/[39m [38;5;241m12.0[39m
[1;32m    645[0m     )
[1;32m    646[0m [38;5;28;01melif[39;00m period[38;5;241m.[39munit [38;5;241m==[39m periods[38;5;241m.[39mYEAR:
[0;32m--> 647[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    649[0m [38;5;28;01mraise[39;00m [38;5;167;01mValueError[39;00m(
[1;32m    650[0m     [38;5;124m"[39m[38;5;124mUnable to divide the value of [39m[38;5;124m'[39m[38;5;132;01m{}[39;00m[38;5;124m'[39m[38;5;124m to match period [39m[38;5;132;01m{}[39;00m[38;5;124m.[39m[38;5;124m"[39m[38;5;241m.[39mformat(
[1;32m    651[0m         variable_name, period
[1;32m    652[0m     )
[1;32m    653[0m )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:732[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    729[0m parameters_at [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mtax_benefit_system[38;5;241m.[39mparameters
[1;32m    731[0m [38;5;28;01mif[39;00m formula[38;5;241m.[39m[38;5;18m__code__[39m[38;5;241m.[39mco_argcount [38;5;241m==[39m [38;5;241m2[39m:
[0;32m--> 732[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    733[0m [38;5;28;01melse[39;00m:
[1;32m    734[0m     array [38;5;241m=[39m formula(population, period, parameters_at)

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/tools/general.py:45[0m, in [0;36mvariable_alias.<locals>.<lambda>[0;34m(entity, period)[0m
[1;32m     41[0m [38;5;250m[39m[38;5;124;03m"""[39;00m
[1;32m     42[0m [38;5;124;03mCopy a variable class and return a new class.[39;00m
[1;32m     43[0m [38;5;124;03m"""[39;00m
[1;32m     44[0m class_dict [38;5;241m=[39m [38;5;28mdict[39m(variable_cls[38;5;241m.[39m[38;5;18m__dict__[39m)
[0;32m---> 45[0m class_dict[[38;5;124m"[39m[38;5;124mformula[39m[38;5;124m"[39m] [38;5;241m=[39m [38;5;28;01mlambda[39;00m entity, period: [43mentity[49m[43m([49m
[1;32m     46[0m [43m    [49m[43mvariable_cls[49m[38;5;241;43m.[39;49m[38;5;18;43m__name__[39;49m[43m,[49m[43m [49m[43mperiod[49m
[1;32m     47[0m [43m[49m[43m)[49m
[1;32m     48[0m [38;5;28;01mreturn[39;00m [38;5;28mtype[39m(
[1;32m     49[0m     name,
[1;32m     50[0m     variable_cls[38;5;241m.[39m[38;5;18m__bases__[39m,
[1;32m     51[0m     class_dict,
[1;32m     52[0m )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/tax/federal_income/income_tax.py:28[0m, in [0;36miitax.formula[0;34m(person, period, parameters)[0m
[1;32m     26[0m     [38;5;28;01mreturn[39;00m [38;5;241m0[39m
[1;32m     27[0m [38;5;28;01melse[39;00m:
[0;32m---> 28[0m     added_components [38;5;241m=[39m [43madd[49m[43m([49m[43mperson[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43miitax[49m[38;5;241;43m.[39;49m[43madds[49m[43m)[49m
[1;32m     29[0m     subtracted_components [38;5;241m=[39m add(person, period, iitax[38;5;241m.[39msubtracts)
[1;32m     30[0m     [38;5;28;01mreturn[39;00m added_components [38;5;241m-[39m subtracted_components

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    203[0m [38;5;28;01mdef[39;00m [38;5;21madd[39m(
[1;32m    204[0m     entity: Population,
[1;32m    205[0m     period: Period,
[1;32m    206[0m     variables: List[[38;5;28mstr[39m],
[1;32m    207[0m     options: List[[38;5;28mstr[39m] [38;5;241m=[39m [38;5;28;01mNone[39;00m,
[1;32m    208[0m ):
[1;32m    209[0m [38;5;250m    [39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03m    Args:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m        ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m    """[39;00m
[0;32m--> 223[0m     [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m        [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    177[0m variable_entity [38;5;241m=[39m entity[38;5;241m.[39mentity[38;5;241m.[39mget_variable(variable)[38;5;241m.[39mentity
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:
[1;32m    181[0m     values [38;5;241m=[39m group_agg_func(
[1;32m    182[0m         entity[38;5;241m.[39mmembers(variable, period, options[38;5;241m=[39moptions)
[1;32m    183[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    695[0m     values [38;5;241m=[39m [38;5;241m0[39m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:
[1;32m    701[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(variable[38;5;241m.[39msubtracts, [38;5;28mstr[39m):

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    695[0m     values [38;5;241m=[39m [38;5;241m0[39m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:
[1;32m    701[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(variable[38;5;241m.[39msubtracts, [38;5;28mstr[39m):

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/tax/federal_income/before_credits/income_tax_main_rates.py:14[0m, in [0;36mincome_tax_main_rates.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     12[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[1;32m     13[0m     [38;5;66;03m# compute taxable income that is taxed at the main rates[39;00m
[0;32m---> 14[0m     full_taxable_income [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mtaxable_income[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     15[0m     cg_exclusion [38;5;241m=[39m tax_unit(
[1;32m     16[0m         [38;5;124m"[39m[38;5;124mcapital_gains_excluded_from_taxable_income[39m[38;5;124m"[39m, period
[1;32m     17[0m     )
[1;32m     18[0m     taxinc [38;5;241m=[39m max_([38;5;241m0[39m, full_taxable_income [38;5;241m-[39m cg_exclusion)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/income/taxable_income/taxable_income.py:13[0m, in [0;36mtaxable_income.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     11[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[1;32m     12[0m     agi [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124madjusted_gross_income[39m[38;5;124m"[39m, period)
[0;32m---> 13[0m     deductions [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mtaxable_income_deductions[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     14[0m     [38;5;28;01mreturn[39;00m max_([38;5;241m0[39m, agi [38;5;241m-[39m deductions)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/income/taxable_income/deductions/taxable_income_deductions.py:13[0m, in [0;36mtaxable_income_deductions.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     11[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[1;32m     12[0m     itemizes [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mtax_unit_itemizes[39m[38;5;124m"[39m, period)
[0;32m---> 13[0m     deductions_if_itemizing [38;5;241m=[39m [43mtax_unit[49m[43m([49m
[1;32m     14[0m [43m        [49m[38;5;124;43m"[39;49m[38;5;124;43mtaxable_income_deductions_if_itemizing[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m
[1;32m     15[0m [43m    [49m[43m)[49m
[1;32m     16[0m     deductions_if_not_itemizing [38;5;241m=[39m tax_unit(
[1;32m     17[0m         [38;5;124m"[39m[38;5;124mtaxable_income_deductions_if_not_itemizing[39m[38;5;124m"[39m, period
[1;32m     18[0m     )
[1;32m     19[0m     [38;5;28;01mreturn[39;00m where(
[1;32m     20[0m         itemizes, deductions_if_itemizing, deductions_if_not_itemizing
[1;32m     21[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    695[0m     values [38;5;241m=[39m [38;5;241m0[39m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:
[1;32m    701[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(variable[38;5;241m.[39msubtracts, [38;5;28mstr[39m):

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/income/taxable_income/deductions/itemizing/salt_deduction.py:14[0m, in [0;36msalt_deduction.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     13[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[0;32m---> 14[0m     salt_amount [38;5;241m=[39m [43madd[49m[43m([49m
[1;32m     15[0m [43m        [49m[43mtax_unit[49m[43m,[49m
[1;32m     16[0m [43m        [49m[43mperiod[49m[43m,[49m
[1;32m     17[0m [43m        [49m[43m[[49m[38;5;124;43m"[39;49m[38;5;124;43mstate_and_local_sales_or_income_tax[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[38;5;124;43m"[39;49m[38;5;124;43mreal_estate_taxes[39;49m[38;5;124;43m"[39;49m[43m][49m[43m,[49m
[1;32m     18[0m [43m    [49m[43m)[49m
[1;32m     19[0m     salt [38;5;241m=[39m parameters(
[1;32m     20[0m         period
[1;32m     21[0m     )[38;5;241m.[39mgov[38;5;241m.[39mirs[38;5;241m.[39mdeductions[38;5;241m.[39mitemized[38;5;241m.[39msalt_and_real_estate
[1;32m     22[0m     cap [38;5;241m=[39m salt[38;5;241m.[39mcap[tax_unit([38;5;124m"[39m[38;5;124mfiling_status[39m[38;5;124m"[39m, period)]

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    203[0m [38;5;28;01mdef[39;00m [38;5;21madd[39m(
[1;32m    204[0m     entity: Population,
[1;32m    205[0m     period: Period,
[1;32m    206[0m     variables: List[[38;5;28mstr[39m],
[1;32m    207[0m     options: List[[38;5;28mstr[39m] [38;5;241m=[39m [38;5;28;01mNone[39;00m,
[1;32m    208[0m ):
[1;32m    209[0m [38;5;250m    [39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03m    Args:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m        ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m    """[39;00m
[0;32m--> 223[0m     [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m        [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    177[0m variable_entity [38;5;241m=[39m entity[38;5;241m.[39mentity[38;5;241m.[39mget_variable(variable)[38;5;241m.[39mentity
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:
[1;32m    181[0m     values [38;5;241m=[39m group_agg_func(
[1;32m    182[0m         entity[38;5;241m.[39mmembers(variable, period, options[38;5;241m=[39moptions)
[1;32m    183[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/irs/taxcalc/deductions/itemized/state_and_local_sales_or_income_tax.py:13[0m, in [0;36mstate_and_local_sales_or_income_tax.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     11[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[1;32m     12[0m     [38;5;66;03m# Only sales or income tax can be itemized, but not both.[39;00m
[0;32m---> 13[0m     income_tax [38;5;241m=[39m [43madd[49m[43m([49m
[1;32m     14[0m [43m        [49m[43mtax_unit[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43m[[49m[38;5;124;43m"[39;49m[38;5;124;43mstate_income_tax[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[38;5;124;43m"[39;49m[38;5;124;43mlocal_income_tax[39;49m[38;5;124;43m"[39;49m[43m][49m
[1;32m     15[0m [43m    [49m[43m)[49m
[1;32m     16[0m     sales_tax [38;5;241m=[39m add(
[1;32m     17[0m         tax_unit, period, [[38;5;124m"[39m[38;5;124mstate_sales_tax[39m[38;5;124m"[39m, [38;5;124m"[39m[38;5;124mlocal_sales_tax[39m[38;5;124m"[39m]
[1;32m     18[0m     )
[1;32m     19[0m     [38;5;28;01mreturn[39;00m max_(income_tax, sales_tax)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    203[0m [38;5;28;01mdef[39;00m [38;5;21madd[39m(
[1;32m    204[0m     entity: Population,
[1;32m    205[0m     period: Period,
[1;32m    206[0m     variables: List[[38;5;28mstr[39m],
[1;32m    207[0m     options: List[[38;5;28mstr[39m] [38;5;241m=[39m [38;5;28;01mNone[39;00m,
[1;32m    208[0m ):
[1;32m    209[0m [38;5;250m    [39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03m    Args:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m        ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m    """[39;00m
[0;32m--> 223[0m     [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m        [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    177[0m variable_entity [38;5;241m=[39m entity[38;5;241m.[39mentity[38;5;241m.[39mget_variable(variable)[38;5;241m.[39mentity
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:
[1;32m    181[0m     values [38;5;241m=[39m group_agg_func(
[1;32m    182[0m         entity[38;5;241m.[39mmembers(variable, period, options[38;5;241m=[39moptions)
[1;32m    183[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/tax/income/state_income_tax.py:44[0m, in [0;36mstate_income_tax.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     38[0m     [38;5;28;01mreturn[39;00m where(
[1;32m     39[0m         total_tax_unit_heads [38;5;241m>[39m [38;5;241m0[39m,
[1;32m     40[0m         spm_unit_state_tax [38;5;241m/[39m total_tax_unit_heads,
[1;32m     41[0m         [38;5;241m0[39m,
[1;32m     42[0m     )
[1;32m     43[0m [38;5;28;01melse[39;00m:
[0;32m---> 44[0m     [38;5;28;01mreturn[39;00m [43madd[49m[43m([49m[43mtax_unit[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mstate_income_tax[49m[38;5;241;43m.[39;49m[43madds[49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223[0m, in [0;36madd[0;34m(entity, period, variables, options)[0m
[1;32m    203[0m [38;5;28;01mdef[39;00m [38;5;21madd[39m(
[1;32m    204[0m     entity: Population,
[1;32m    205[0m     period: Period,
[1;32m    206[0m     variables: List[[38;5;28mstr[39m],
[1;32m    207[0m     options: List[[38;5;28mstr[39m] [38;5;241m=[39m [38;5;28;01mNone[39;00m,
[1;32m    208[0m ):
[1;32m    209[0m [38;5;250m    [39m[38;5;124;03m"""Sums a list of variables.[39;00m
[1;32m    210[0m 
[1;32m    211[0m [38;5;124;03m    Args:[39;00m
[0;32m   (...)[0m
[1;32m    221[0m [38;5;124;03m        ArrayLike: The result of the operation.[39;00m
[1;32m    222[0m [38;5;124;03m    """[39;00m
[0;32m--> 223[0m     [38;5;28;01mreturn[39;00m [43mfor_each_variable[49m[43m([49m
[1;32m    224[0m [43m        [49m[43mentity[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mvariables[49m[43m,[49m[43m [49m[43magg_func[49m[38;5;241;43m=[39;49m[38;5;124;43m"[39;49m[38;5;124;43madd[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m
[1;32m    225[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:179[0m, in [0;36mfor_each_variable[0;34m(entity, period, variables, agg_func, group_agg_func, options)[0m
[1;32m    177[0m variable_entity [38;5;241m=[39m entity[38;5;241m.[39mentity[38;5;241m.[39mget_variable(variable)[38;5;241m.[39mentity
[1;32m    178[0m [38;5;28;01mif[39;00m variable_entity[38;5;241m.[39mkey [38;5;241m==[39m entity[38;5;241m.[39mentity[38;5;241m.[39mkey:
[0;32m--> 179[0m     values [38;5;241m=[39m [43mentity[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43moptions[49m[38;5;241;43m=[39;49m[43moptions[49m[43m)[49m
[1;32m    180[0m [38;5;28;01melif[39;00m variable_entity[38;5;241m.[39mis_person:
[1;32m    181[0m     values [38;5;241m=[39m group_agg_func(
[1;32m    182[0m         entity[38;5;241m.[39mmembers(variable, period, options[38;5;241m=[39moptions)
[1;32m    183[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    695[0m     values [38;5;241m=[39m [38;5;241m0[39m
[1;32m    696[0m     [38;5;28;01mfor[39;00m added_variable [38;5;129;01min[39;00m adds_list:
[0;32m--> 697[0m         values [38;5;241m=[39m values [38;5;241m+[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    698[0m [43m            [49m[43madded_variable[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mmap_to[49m[38;5;241;43m=[39;49m[43mvariable[49m[38;5;241;43m.[39;49m[43mentity[49m[38;5;241;43m.[39;49m[43mkey[49m
[1;32m    699[0m [43m        [49m[43m)[49m
[1;32m    700[0m [38;5;28;01mif[39;00m variable[38;5;241m.[39msubtracts [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:
[1;32m    701[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(variable[38;5;241m.[39msubtracts, [38;5;28mstr[39m):

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/ca/tax/income/ca_income_tax_before_refundable_credits.py:14[0m, in [0;36mca_income_tax_before_refundable_credits.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     13[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[0;32m---> 14[0m     itax [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mca_income_tax_before_credits[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     15[0m     nonrefundable_credits [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mca_nonrefundable_credits[39m[38;5;124m"[39m, period)
[1;32m     16[0m     [38;5;28;01mreturn[39;00m max_([38;5;241m0[39m, itax [38;5;241m-[39m nonrefundable_credits)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/ca/tax/income/ca_income_tax_before_credits.py:15[0m, in [0;36mca_income_tax_before_credits.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     13[0m [38;5;28;01mdef[39;00m [38;5;21mformula[39m(tax_unit, period, parameters):
[1;32m     14[0m     filing_status [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mfiling_status[39m[38;5;124m"[39m, period)
[0;32m---> 15[0m     taxable_income [38;5;241m=[39m [43mtax_unit[49m[43m([49m[38;5;124;43m"[39;49m[38;5;124;43mca_taxable_income[39;49m[38;5;124;43m"[39;49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m     16[0m     p [38;5;241m=[39m parameters(period)[38;5;241m.[39mgov[38;5;241m.[39mstates[38;5;241m.[39mca[38;5;241m.[39mtax[38;5;241m.[39mincome[38;5;241m.[39mrates
[1;32m     18[0m     statuses [38;5;241m=[39m filing_status[38;5;241m.[39mpossible_values

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134[0m, in [0;36mPopulation.__call__[0;34m(self, variable_name, period, options)[0m
[1;32m    130[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39msimulation[38;5;241m.[39mcalculate_divide(
[1;32m    131[0m         variable_name, period, [38;5;241m*[39m[38;5;241m*[39mcalculate_kwargs
[1;32m    132[0m     )
[1;32m    133[0m [38;5;28;01melse[39;00m:
[0;32m--> 134[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msimulation[49m[38;5;241;43m.[39;49m[43mcalculate[49m[43m([49m
[1;32m    135[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcalculate_kwargs[49m
[1;32m    136[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330[0m, in [0;36mSimulation.calculate[0;34m(self, variable_name, period, map_to, decode_enums)[0m
[1;32m    325[0m [38;5;28mself[39m[38;5;241m.[39mtracer[38;5;241m.[39mrecord_calculation_start(
[1;32m    326[0m     variable_name, period, [38;5;28mself[39m[38;5;241m.[39mbranch_name
[1;32m    327[0m )
[1;32m    329[0m [38;5;28;01mtry[39;00m:
[0;32m--> 330[0m     result [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_calculate[49m[43m([49m[43mvariable_name[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    331[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(result, EnumArray) [38;5;129;01mand[39;00m decode_enums:
[1;32m    332[0m         result [38;5;241m=[39m result[38;5;241m.[39mdecode_to_str()

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491[0m, in [0;36mSimulation._calculate[0;34m(self, variable_name, period)[0m
[1;32m    489[0m [38;5;28;01mtry[39;00m:
[1;32m    490[0m     [38;5;28mself[39m[38;5;241m.[39m_check_for_cycle(variable[38;5;241m.[39mname, period)
[0;32m--> 491[0m     array [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_run_formula[49m[43m([49m[43mvariable[49m[43m,[49m[43m [49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m)[49m
[1;32m    493[0m     [38;5;66;03m# If no result, use the default value and cache it[39;00m
[1;32m    494[0m     [38;5;28;01mif[39;00m array [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    495[0m         [38;5;66;03m# Check if the variable has a previously defined value[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734[0m, in [0;36mSimulation._run_formula[0;34m(self, variable, population, period)[0m
[1;32m    732[0m     array [38;5;241m=[39m formula(population, period)
[1;32m    733[0m [38;5;28;01melse[39;00m:
[0;32m--> 734[0m     array [38;5;241m=[39m [43mformula[49m[43m([49m[43mpopulation[49m[43m,[49m[43m [49m[43mperiod[49m[43m,[49m[43m [49m[43mparameters_at[49m[43m)[49m
[1;32m    736[0m [38;5;28;01mreturn[39;00m array

File [0;32m~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/states/ca/tax/income/ca_taxable_income.py:19[0m, in [0;36mca_taxable_income.formula[0;34m(tax_unit, period, parameters)[0m
[1;32m     17[0m filing_status [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mfiling_status[39m[38;5;124m"[39m, period)
[1;32m     18[0m p [38;5;241m=[39m parameters(period)[38;5;241m.[39mgov[38;5;241m.[39mstates[38;5;241m.[39mca[38;5;241m.[39mtax[38;5;241m.[39mincome
[0;32m---> 19[0m std_ded [38;5;241m=[39m [43mp[49m[38;5;241;43m.[39;49m[43mdeductions[49m[38;5;241;43m.[39;49m[43mstandard[49m[38;5;241;43m.[39;49m[43mamount[49m[43m[[49m[43mfiling_status[49m[43m][49m
[1;32m     20[0m itm_ded [38;5;241m=[39m tax_unit([38;5;124m"[39m[38;5;124mca_itemized_deductions[39m[38;5;124m"[39m, period)
[1;32m     21[0m ded [38;5;241m=[39m where(itm_ded [38;5;241m>[39m std_ded, itm_ded, std_ded)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/parameters/parameter_node_at_instant.py:58[0m, in [0;36mParameterNodeAtInstant.__getitem__[0;34m(self, key)[0m
[1;32m     53[0m [38;5;28;01mdef[39;00m [38;5;21m__getitem__[39m(
[1;32m     54[0m     [38;5;28mself[39m, key: [38;5;28mstr[39m
[1;32m     55[0m ) [38;5;241m-[39m[38;5;241m>[39m Union[[38;5;124m"[39m[38;5;124mParameterNodeAtInstant[39m[38;5;124m"[39m, VectorialParameterNodeAtInstant]:
[1;32m     56[0m     [38;5;66;03m# If fancy indexing is used, cast to a vectorial node[39;00m
[1;32m     57[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(key, numpy[38;5;241m.[39mndarray):
[0;32m---> 58[0m         [38;5;28;01mreturn[39;00m [43mparameters[49m[38;5;241;43m.[39;49m[43mVectorialParameterNodeAtInstant[49m[38;5;241;43m.[39;49m[43mbuild_from_node[49m[43m([49m
[1;32m     59[0m [43m            [49m[38;5;28;43mself[39;49m
[1;32m     60[0m [43m        [49m[43m)[49m[43m[[49m[43mkey[49m[43m][49m
[1;32m     61[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39m_children[key]

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/parameters/vectorial_parameter_node_at_instant.py:216[0m, in [0;36mVectorialParameterNodeAtInstant.__getitem__[0;34m(self, key)[0m
[1;32m    211[0m         key [38;5;241m=[39m key[38;5;241m.[39mastype([38;5;124m"[39m[38;5;124mstr[39m[38;5;124m"[39m)
[1;32m    212[0m names [38;5;241m=[39m [38;5;28mlist[39m(
[1;32m    213[0m     [38;5;28mself[39m[38;5;241m.[39mdtype[38;5;241m.[39mnames
[1;32m    214[0m )  [38;5;66;03m# Get all the names of the subnodes, e.g. ['zone_1', 'zone_2'][39;00m
[1;32m    215[0m default [38;5;241m=[39m numpy[38;5;241m.[39mfull_like(
[0;32m--> 216[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mvector[49m[43m[[49m[43mkey[49m[43m[[49m[38;5;241;43m0[39;49m[43m][49m[43m][49m, numpy[38;5;241m.[39mnan
[1;32m    217[0m )  [38;5;66;03m# In case of unexpected key, we will set the corresponding value to NaN.[39;00m
[1;32m    218[0m conditions [38;5;241m=[39m [key [38;5;241m==[39m name [38;5;28;01mfor[39;00m name [38;5;129;01min[39;00m names]
[1;32m    219[0m values [38;5;241m=[39m [[38;5;28mself[39m[38;5;241m.[39mvector[name] [38;5;28;01mfor[39;00m name [38;5;129;01min[39;00m names]

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/numpy/core/records.py:510[0m, in [0;36mrecarray.__getitem__[0;34m(self, indx)[0m
[1;32m    509[0m [38;5;28;01mdef[39;00m [38;5;21m__getitem__[39m([38;5;28mself[39m, indx):
[0;32m--> 510[0m     obj [38;5;241m=[39m [38;5;28;43msuper[39;49m[43m([49m[43m)[49m[38;5;241;43m.[39;49m[38;5;21;43m__getitem__[39;49m[43m([49m[43mindx[49m[43m)[49m
[1;32m    512[0m     [38;5;66;03m# copy behavior of getattr, except that here[39;00m
[1;32m    513[0m     [38;5;66;03m# we might also be returning a single element[39;00m
[1;32m    514[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(obj, ndarray):

[0;31mValueError[0m: no field of name SINGLE

