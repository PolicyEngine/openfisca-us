<!doctype html>
<html class="no-js" lang="en">
  <head><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><link rel="next" title="Massachusetts income tax" href="tax/income/index.html" /><link rel="prev" title="Massachusetts" href="index.html" />

    <!-- Generated with Sphinx 5.0.2 and Furo 2023.03.27 -->
        <title>Massachusetts tax and benefit system - PolicyEngine US documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">PolicyEngine US documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  
  <span class="sidebar-brand-text">PolicyEngine US documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Government programs</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../fcc/index.html">FCC</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fcc/lifeline.html">Lifeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fcc/acp.html">Affordable Connectivity Program</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../hhs/index.html">HHS</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../hhs/tanf.html">Temporary Assistance for Needy Families (TANF)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../hud/index.html">HUD</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../hud/housing-assistance.html">Housing assistance</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../irs/tax.html">IRS</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../irs/credits/eitc.html">Earned Income Tax Credit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../irs/credits/cdcc.html">Child and Dependent Care Credit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../irs/credits/clean-vehicle.html">Clean vehicle credit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../irs/capital-gains.html">Capital Gains Tax</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ssa/index.html">SSA</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ssa/ssi.html">SSI</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">States</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../ca/index.html">California</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../ca/calepa/carb/cvrp.html">California Clean Vehicle Rebate Project (CVRP)</a></li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Massachusetts</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">Massachusetts tax and benefit system</a></li>
<li class="toctree-l3"><a class="reference internal" href="tax/income/index.html">Massachusetts income tax</a></li>
<li class="toctree-l3"><a class="reference internal" href="tax/income/credits/senior-circuit-breaker.html">Massachusetts Senior Circuit Breaker Credit</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../md/index.html">Maryland</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../md/tax/income/index.html">Maryland state income tax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../md/tax/income/credits/cdcc.html">Maryland Child and Dependent Care Credit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../md/tax/income/credits/ctc.html">Maryland Child Tax Credit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../md/tax/income/credits/eitc.html">Maryland Earned Income Tax Credit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../md/tax/income/credits/poverty-line-credit.html">Maryland Poverty Line Credit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../md/tax/income/deductions/standard-deduction.html">Maryland Standard Deduction</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../ny/index.html">New York</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../ny/cdcc.html">NY Child and Dependent Care Credit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ny/ctc.html">Empire State Child Credit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ny/eitc.html">New York EITC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ny/tax.html">New York state income tax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ny/tax-benefit.html">New York State income tax</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../pa/tax.html">Pennsylvania</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../wa/index.html">Washington</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../wa/tax/income/credits/working-families-tax-credit.html">Washington Working Families Tax Credit</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../usda/index.html">USDA</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../usda/snap.html">SNAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usda/school-meals.html">School meals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usda/wic.html">WIC</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Validation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../validation/taxsim.html">Validation against TAXSIM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/speed.html">Speed</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="massachusetts-tax-and-benefit-system">
<h1>Massachusetts tax and benefit system<a class="headerlink" href="#massachusetts-tax-and-benefit-system" title="Permalink to this heading">#</a></h1>
<p>This notebook shows how the state and federal tax and benefit system affects Massachusetts residents holistically.</p>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">#</a></h2>
<p>Consider a set of Massachusetts family types, each with $1,000 monthly rent and $50 monthly broadband costs, and varying in terms of marital status and number of children.
Their net income—after state and federal taxes and benefits modeled by OpenFisca US—is shown in the graph below.</p>
<p><em>The cliff is due to Massachusetts’ emergency SNAP allotment, which entitles SNAP-eligible households to the maximum benefit for their household size; this also affects other benefits through categorical eligibility.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">policyengine_us</span> <span class="kn">import</span> <span class="n">IndividualSim</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="n">LIGHT_GRAY</span> <span class="o">=</span> <span class="s2">&quot;#F5F5F5&quot;</span>
<span class="n">GRAY</span> <span class="o">=</span> <span class="s2">&quot;#BDBDBD&quot;</span>
<span class="n">BLUE</span> <span class="o">=</span> <span class="s2">&quot;#5091cc&quot;</span>
<span class="n">LIGHT_BLUE</span> <span class="o">=</span> <span class="s2">&quot;lightblue&quot;</span>
<span class="n">DARK_BLUE</span> <span class="o">=</span> <span class="s2">&quot;darkblue&quot;</span>


<span class="k">def</span> <span class="nf">make_tax</span><span class="p">(</span><span class="n">adults</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">IndividualSim</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2022</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">add_person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">rent</span><span class="o">=</span><span class="mi">12_000</span><span class="p">)</span>
    <span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">adults</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">add_person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;spouse&quot;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">members</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;spouse&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
        <span class="n">child</span> <span class="o">=</span> <span class="s2">&quot;child</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">add_person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">child</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">members</span> <span class="o">+=</span> <span class="p">[</span><span class="n">child</span><span class="p">]</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">add_tax_unit</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;tax_unit&quot;</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="n">members</span><span class="p">,</span> <span class="n">premium_tax_credit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># $1,000 monthly rent, $50 monthly broadband.</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">add_spm_unit</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;spm_unit&quot;</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="n">members</span><span class="p">,</span> <span class="n">broadband_cost</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">add_household</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;household&quot;</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="n">members</span><span class="p">,</span> <span class="n">state_code</span><span class="o">=</span><span class="s2">&quot;MA&quot;</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">vary</span><span class="p">(</span><span class="s2">&quot;employment_income&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100_000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">employment_income</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="s2">&quot;employment_income&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">spm_unit_net_income</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="s2">&quot;spm_unit_net_income&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
    <span class="n">mtr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span>
        <span class="s2">&quot;spm_unit_net_income&quot;</span><span class="p">,</span> <span class="s2">&quot;employment_income&quot;</span><span class="p">,</span> <span class="n">wrt_target</span><span class="o">=</span><span class="s2">&quot;head&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">employment_income</span><span class="o">=</span><span class="n">employment_income</span><span class="p">,</span>
            <span class="n">spm_unit_net_income</span><span class="o">=</span><span class="n">spm_unit_net_income</span><span class="p">,</span>
            <span class="n">mtr</span><span class="o">=</span><span class="n">mtr</span><span class="p">,</span>
            <span class="n">adults</span><span class="o">=</span><span class="n">adults</span><span class="p">,</span>
            <span class="n">children</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">children</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="c1"># Make a table of state taxes for different numbers of adults and children.</span>
<span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">adults</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">children</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_tax</span><span class="p">(</span><span class="n">adults</span><span class="p">,</span> <span class="n">children</span><span class="p">))</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

<span class="n">LABELS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">employment_income</span><span class="o">=</span><span class="s2">&quot;Employment income&quot;</span><span class="p">,</span>
    <span class="n">spm_unit_net_income</span><span class="o">=</span><span class="s2">&quot;Net income&quot;</span><span class="p">,</span>
    <span class="n">mtr</span><span class="o">=</span><span class="s2">&quot;Marginal tax rate&quot;</span><span class="p">,</span>
    <span class="n">adults</span><span class="o">=</span><span class="s2">&quot;Adults&quot;</span><span class="p">,</span>
    <span class="n">children</span><span class="o">=</span><span class="s2">&quot;Children&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">COLOR_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="n">GRAY</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="n">LIGHT_BLUE</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="n">BLUE</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="n">DARK_BLUE</span><span class="p">}</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="s2">&quot;employment_income&quot;</span><span class="p">,</span>
    <span class="s2">&quot;spm_unit_net_income&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;children&quot;</span><span class="p">,</span>
    <span class="n">animation_frame</span><span class="o">=</span><span class="s2">&quot;adults&quot;</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">LABELS</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Net income for a Massachusetts household&quot;</span><span class="p">,</span>
    <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">COLOR_MAP</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">xaxis_tickformat</span><span class="o">=</span><span class="s2">&quot;$,&quot;</span><span class="p">,</span>
    <span class="n">yaxis_tickformat</span><span class="o">=</span><span class="s2">&quot;$,&quot;</span><span class="p">,</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">xaxis_gridcolor</span><span class="o">=</span><span class="n">LIGHT_GRAY</span><span class="p">,</span>
    <span class="n">yaxis_gridcolor</span><span class="o">=</span><span class="n">LIGHT_GRAY</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/individual_sim.py:261,</span> in <span class="ni">IndividualSim.calc</span><span class="nt">(self, var, period, target, index, map_to, reform)</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">261</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">262</span> <span class="k">except</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">696</span>     <span class="k">for</span> <span class="n">added_variable</span> <span class="ow">in</span> <span class="n">adds_list</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">697</span>         <span class="n">values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">698</span>             <span class="n">added_variable</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">map_to</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span>
<span class="g g-Whitespace">    </span><span class="mi">699</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span> <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">subtracts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/household/income/spm_unit/spm_unit_benefits.py:34,</span> in <span class="ni">spm_unit_benefits.formula</span><span class="nt">(spm_unit, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span>     <span class="n">BENEFITS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;spm_unit_capped_housing_subsidy&quot;</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">34</span> <span class="k">return</span> <span class="n">add</span><span class="p">(</span><span class="n">spm_unit</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">BENEFITS</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223,</span> in <span class="ni">add</span><span class="nt">(entity, period, variables, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;Sums a list of variables.</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">211</span><span class="sd"> Args:</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span><span class="sd">     ArrayLike: The result of the operation.</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">223</span> <span class="k">return</span> <span class="n">for_each_variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span>     <span class="n">entity</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span>
<span class="g g-Whitespace">    </span><span class="mi">225</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:182,</span> in <span class="ni">for_each_variable</span><span class="nt">(entity, period, variables, agg_func, group_agg_func, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> <span class="k">elif</span> <span class="n">variable_entity</span><span class="o">.</span><span class="n">is_person</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>     <span class="n">values</span> <span class="o">=</span> <span class="n">group_agg_func</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">182</span>         <span class="n">entity</span><span class="o">.</span><span class="n">members</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">183</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span> <span class="k">elif</span> <span class="n">entity</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">is_person</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/ssi.py:16,</span> in <span class="ni">ssi.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="k">return</span> <span class="mi">0</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="k">return</span> <span class="n">max_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;uncapped_ssi&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">))</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/uncapped_ssi.py:13,</span> in <span class="ni">uncapped_ssi.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="k">def</span> <span class="nf">formula</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">13</span>     <span class="n">amount</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;ssi_amount_if_eligible&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="n">meets_resource_test</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;meets_ssi_resource_test&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/ssi_amount_if_eligible.py:16,</span> in <span class="ni">ssi_amount_if_eligible.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">ssi</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">gov</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">ssi</span><span class="o">.</span><span class="n">amount</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="k">return</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="n">where</span><span class="p">(</span>
<span class="ne">---&gt; </span><span class="mi">16</span>         <span class="n">person</span><span class="p">(</span><span class="s2">&quot;ssi_claim_is_joint&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">),</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>         <span class="n">ssi</span><span class="o">.</span><span class="n">couple</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span>         <span class="n">ssi</span><span class="o">.</span><span class="n">individual</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>     <span class="o">*</span> <span class="n">MONTHS_IN_YEAR</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/ssi_claim_is_joint.py:12,</span> in <span class="ni">ssi_claim_is_joint.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">eligible</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;is_ssi_aged_blind_disabled&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">12</span> <span class="n">both_eligible</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">marital_unit</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eligible</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">income_is_deemed</span> <span class="o">=</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="n">person</span><span class="p">(</span><span class="s2">&quot;ssi_income_deemed_from_ineligible_spouse&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/projectors/projector.py:28,</span> in <span class="ni">Projector.__getattr__.&lt;locals&gt;.projector_function</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="n">result</span> <span class="o">=</span> <span class="n">reference_attr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">28</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_and_bubble_up</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/projectors/projector.py:37,</span> in <span class="ni">Projector.transform_and_bubble_up</span><span class="nt">(self, result)</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span> <span class="k">def</span> <span class="nf">transform_and_bubble_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">37</span>     <span class="n">transformed_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/projectors/entity_to_person_projector.py:19,</span> in <span class="ni">EntityToPersonProjector.transform</span><span class="nt">(self, result)</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayLike</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">19</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_entity</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/group_population.py:335,</span> in <span class="ni">GroupPopulation.project</span><span class="nt">(self, array, role)</span>
<span class="g g-Whitespace">    </span><span class="mi">334</span> <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="n">Role</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayLike</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">335</span>     <span class="bp">self</span><span class="o">.</span><span class="n">check_array_compatible_with_entity</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">336</span>     <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">check_role_validity</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:60,</span> in <span class="ni">Population.check_array_compatible_with_entity</span><span class="nt">(self, array)</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">60</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">61</span>         <span class="s2">&quot;Input </span><span class="si">{}</span><span class="s2"> is not a valid value for the entity </span><span class="si">{}</span><span class="s2"> (size = </span><span class="si">{}</span><span class="s2"> != </span><span class="si">{}</span><span class="s2"> = count)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">62</span>             <span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span>         <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span>     <span class="p">)</span>

<span class="ne">ValueError</span>: Input [0. 0. 0. ... 0. 0. 0.] is not a valid value for the entity marital_unit (size = 3001 != 3003 = count)

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/individual_sim.py:264,</span> in <span class="ni">IndividualSim.calc</span><span class="nt">(self, var, period, target, index, map_to, reform)</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">264</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">calculate_add</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span> <span class="k">except</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:610,</span> in <span class="ni">Simulation.calculate_add</span><span class="nt">(self, variable_name, period, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">604</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">605</span>         <span class="s2">&quot;Unable to sum constant variable &#39;</span><span class="si">{}</span><span class="s2">&#39; over period </span><span class="si">{}</span><span class="s2">: only variables defined daily, monthly, or yearly can be summed over time.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">606</span>             <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span>
<span class="g g-Whitespace">    </span><span class="mi">607</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">608</span>     <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">610</span> <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">611</span>     <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">sub_period</span><span class="p">)</span>
<span class="nn">    612     for sub_period</span> in <span class="ni">period.get_subperiods</span><span class="nt">(variable.definition_period)</span>
<span class="g g-Whitespace">    </span><span class="mi">613</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:611,</span> in <span class="ni">&lt;genexpr&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">604</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">605</span>         <span class="s2">&quot;Unable to sum constant variable &#39;</span><span class="si">{}</span><span class="s2">&#39; over period </span><span class="si">{}</span><span class="s2">: only variables defined daily, monthly, or yearly can be summed over time.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">606</span>             <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span>
<span class="g g-Whitespace">    </span><span class="mi">607</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">608</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">610</span> <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">611</span>     <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">sub_period</span><span class="p">)</span>
<span class="nn">    612     for sub_period</span> in <span class="ni">period.get_subperiods</span><span class="nt">(variable.definition_period)</span>
<span class="g g-Whitespace">    </span><span class="mi">613</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">696</span>     <span class="k">for</span> <span class="n">added_variable</span> <span class="ow">in</span> <span class="n">adds_list</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">697</span>         <span class="n">values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">698</span>             <span class="n">added_variable</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">map_to</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span>
<span class="g g-Whitespace">    </span><span class="mi">699</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span> <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">subtracts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/household/income/spm_unit/spm_unit_benefits.py:34,</span> in <span class="ni">spm_unit_benefits.formula</span><span class="nt">(spm_unit, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span>     <span class="n">BENEFITS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;spm_unit_capped_housing_subsidy&quot;</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">34</span> <span class="k">return</span> <span class="n">add</span><span class="p">(</span><span class="n">spm_unit</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">BENEFITS</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223,</span> in <span class="ni">add</span><span class="nt">(entity, period, variables, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;Sums a list of variables.</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">211</span><span class="sd"> Args:</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span><span class="sd">     ArrayLike: The result of the operation.</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">223</span> <span class="k">return</span> <span class="n">for_each_variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span>     <span class="n">entity</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span>
<span class="g g-Whitespace">    </span><span class="mi">225</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:182,</span> in <span class="ni">for_each_variable</span><span class="nt">(entity, period, variables, agg_func, group_agg_func, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> <span class="k">elif</span> <span class="n">variable_entity</span><span class="o">.</span><span class="n">is_person</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>     <span class="n">values</span> <span class="o">=</span> <span class="n">group_agg_func</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">182</span>         <span class="n">entity</span><span class="o">.</span><span class="n">members</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">183</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span> <span class="k">elif</span> <span class="n">entity</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">is_person</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/ssi.py:16,</span> in <span class="ni">ssi.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="k">return</span> <span class="mi">0</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="k">return</span> <span class="n">max_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;uncapped_ssi&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">))</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/uncapped_ssi.py:13,</span> in <span class="ni">uncapped_ssi.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="k">def</span> <span class="nf">formula</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">13</span>     <span class="n">amount</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;ssi_amount_if_eligible&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="n">meets_resource_test</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;meets_ssi_resource_test&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/ssi_amount_if_eligible.py:16,</span> in <span class="ni">ssi_amount_if_eligible.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">ssi</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">gov</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">ssi</span><span class="o">.</span><span class="n">amount</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="k">return</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="n">where</span><span class="p">(</span>
<span class="ne">---&gt; </span><span class="mi">16</span>         <span class="n">person</span><span class="p">(</span><span class="s2">&quot;ssi_claim_is_joint&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">),</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>         <span class="n">ssi</span><span class="o">.</span><span class="n">couple</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span>         <span class="n">ssi</span><span class="o">.</span><span class="n">individual</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>     <span class="o">*</span> <span class="n">MONTHS_IN_YEAR</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="c1"># If no result, use the default value and cache it</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/ssi_claim_is_joint.py:12,</span> in <span class="ni">ssi_claim_is_joint.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">eligible</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;is_ssi_aged_blind_disabled&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">12</span> <span class="n">both_eligible</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">marital_unit</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eligible</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">income_is_deemed</span> <span class="o">=</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="n">person</span><span class="p">(</span><span class="s2">&quot;ssi_income_deemed_from_ineligible_spouse&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/projectors/projector.py:28,</span> in <span class="ni">Projector.__getattr__.&lt;locals&gt;.projector_function</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="n">result</span> <span class="o">=</span> <span class="n">reference_attr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">28</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_and_bubble_up</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/projectors/projector.py:37,</span> in <span class="ni">Projector.transform_and_bubble_up</span><span class="nt">(self, result)</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span> <span class="k">def</span> <span class="nf">transform_and_bubble_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">37</span>     <span class="n">transformed_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/projectors/entity_to_person_projector.py:19,</span> in <span class="ni">EntityToPersonProjector.transform</span><span class="nt">(self, result)</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayLike</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">19</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_entity</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/group_population.py:335,</span> in <span class="ni">GroupPopulation.project</span><span class="nt">(self, array, role)</span>
<span class="g g-Whitespace">    </span><span class="mi">334</span> <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="n">Role</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayLike</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">335</span>     <span class="bp">self</span><span class="o">.</span><span class="n">check_array_compatible_with_entity</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">336</span>     <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">check_role_validity</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:60,</span> in <span class="ni">Population.check_array_compatible_with_entity</span><span class="nt">(self, array)</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">60</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">61</span>         <span class="s2">&quot;Input </span><span class="si">{}</span><span class="s2"> is not a valid value for the entity </span><span class="si">{}</span><span class="s2"> (size = </span><span class="si">{}</span><span class="s2"> != </span><span class="si">{}</span><span class="s2"> = count)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">62</span>             <span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span>         <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span>     <span class="p">)</span>

<span class="ne">ValueError</span>: Input [0. 0. 0. ... 0. 0. 0.] is not a valid value for the entity marital_unit (size = 3001 != 3003 = count)

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">48</span>
<span class="g g-Whitespace">     </span><span class="mi">46</span> <span class="k">for</span> <span class="n">adults</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">47</span>     <span class="k">for</span> <span class="n">children</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">48</span>         <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_tax</span><span class="p">(</span><span class="n">adults</span><span class="p">,</span> <span class="n">children</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span> <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span> <span class="n">LABELS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>     <span class="n">employment_income</span><span class="o">=</span><span class="s2">&quot;Employment income&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span>     <span class="n">spm_unit_net_income</span><span class="o">=</span><span class="s2">&quot;Net income&quot;</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span>     <span class="n">children</span><span class="o">=</span><span class="s2">&quot;Children&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">58</span> <span class="p">)</span>

<span class="nn">Cell In[1], line 29,</span> in <span class="ni">make_tax</span><span class="nt">(adults, children)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="n">sim</span><span class="o">.</span><span class="n">vary</span><span class="p">(</span><span class="s2">&quot;employment_income&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100_000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span> <span class="n">employment_income</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="s2">&quot;employment_income&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="ne">---&gt; </span><span class="mi">29</span> <span class="n">spm_unit_net_income</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="s2">&quot;spm_unit_net_income&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span> <span class="n">mtr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>     <span class="s2">&quot;spm_unit_net_income&quot;</span><span class="p">,</span> <span class="s2">&quot;employment_income&quot;</span><span class="p">,</span> <span class="n">wrt_target</span><span class="o">=</span><span class="s2">&quot;head&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span>     <span class="nb">dict</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span>         <span class="n">employment_income</span><span class="o">=</span><span class="n">employment_income</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/individual_sim.py:266,</span> in <span class="ni">IndividualSim.calc</span><span class="nt">(self, var, period, target, index, map_to, reform)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>         <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">calculate_add</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">except</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>         <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate_divide</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span> <span class="k">if</span> <span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>     <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="ow">and</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">situation_data</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">plural</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span> <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span>     <span class="n">map_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">key</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:647,</span> in <span class="ni">Simulation.calculate_divide</span><span class="nt">(self, variable_name, period, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">643</span>     <span class="k">return</span> <span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">644</span>         <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">computation_period</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> <span class="k">elif</span> <span class="n">period</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="n">periods</span><span class="o">.</span><span class="n">YEAR</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">650</span>     <span class="s2">&quot;Unable to divide the value of &#39;</span><span class="si">{}</span><span class="s2">&#39; to match period </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">651</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span>
<span class="g g-Whitespace">    </span><span class="mi">652</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">653</span> <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">record_calculation_start</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>     <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_name</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">332</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode_to_str</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">489</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span>     <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span>     <span class="c1"># If no result, use the default value and cache it</span>
<span class="g g-Whitespace">    </span><span class="mi">494</span>     <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">495</span>         <span class="c1"># Check if the variable has a previously defined value</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:697,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">695</span>     <span class="n">values</span> <span class="o">=</span> <span class="mi">0</span>
<span class="g g-Whitespace">    </span><span class="mi">696</span>     <span class="k">for</span> <span class="n">added_variable</span> <span class="ow">in</span> <span class="n">adds_list</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">697</span>         <span class="n">values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">698</span>             <span class="n">added_variable</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">map_to</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span>
<span class="g g-Whitespace">    </span><span class="mi">699</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span> <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">subtracts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">701</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">subtracts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">record_calculation_start</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>     <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_name</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">332</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode_to_str</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">489</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span>     <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span>     <span class="c1"># If no result, use the default value and cache it</span>
<span class="g g-Whitespace">    </span><span class="mi">494</span>     <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">495</span>         <span class="c1"># Check if the variable has a previously defined value</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">732</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/household/income/spm_unit/spm_unit_benefits.py:34,</span> in <span class="ni">spm_unit_benefits.formula</span><span class="nt">(spm_unit, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">parameters</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">gov</span><span class="o">.</span><span class="n">hud</span><span class="o">.</span><span class="n">abolition</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span>     <span class="n">BENEFITS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;spm_unit_capped_housing_subsidy&quot;</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">34</span> <span class="k">return</span> <span class="n">add</span><span class="p">(</span><span class="n">spm_unit</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">BENEFITS</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:223,</span> in <span class="ni">add</span><span class="nt">(entity, period, variables, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="n">entity</span><span class="p">:</span> <span class="n">Population</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">205</span>     <span class="n">period</span><span class="p">:</span> <span class="n">Period</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>     <span class="n">options</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span> <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Sums a list of variables.</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">211</span><span class="sd">     Args:</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span><span class="sd">         ArrayLike: The result of the operation.</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">223</span>     <span class="k">return</span> <span class="n">for_each_variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span>         <span class="n">entity</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span>
<span class="g g-Whitespace">    </span><span class="mi">225</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/commons/formulas.py:182,</span> in <span class="ni">for_each_variable</span><span class="nt">(entity, period, variables, agg_func, group_agg_func, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>     <span class="n">values</span> <span class="o">=</span> <span class="n">entity</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> <span class="k">elif</span> <span class="n">variable_entity</span><span class="o">.</span><span class="n">is_person</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>     <span class="n">values</span> <span class="o">=</span> <span class="n">group_agg_func</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">182</span>         <span class="n">entity</span><span class="o">.</span><span class="n">members</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">183</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span> <span class="k">elif</span> <span class="n">entity</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">is_person</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span>         <span class="sa">f</span><span class="s2">&quot;You requested to aggregate </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2"> (defined for </span><span class="si">{</span><span class="n">variable_entity</span><span class="o">.</span><span class="n">plural</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">plural</span><span class="si">}</span><span class="s2">, but this is not yet implemented.&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">187</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate_divide</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">record_calculation_start</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>     <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_name</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">332</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode_to_str</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">489</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span>     <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span>     <span class="c1"># If no result, use the default value and cache it</span>
<span class="g g-Whitespace">    </span><span class="mi">494</span>     <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">495</span>         <span class="c1"># Check if the variable has a previously defined value</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">732</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/ssi.py:16,</span> in <span class="ni">ssi.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="k">if</span> <span class="n">parameters</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">gov</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">ssi</span><span class="o">.</span><span class="n">abolish_ssi</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="k">return</span> <span class="mi">0</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="k">return</span> <span class="n">max_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;uncapped_ssi&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">))</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate_divide</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">record_calculation_start</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>     <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_name</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">332</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode_to_str</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">489</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span>     <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span>     <span class="c1"># If no result, use the default value and cache it</span>
<span class="g g-Whitespace">    </span><span class="mi">494</span>     <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">495</span>         <span class="c1"># Check if the variable has a previously defined value</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">732</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/uncapped_ssi.py:13,</span> in <span class="ni">uncapped_ssi.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="k">def</span> <span class="nf">formula</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">13</span>     <span class="n">amount</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;ssi_amount_if_eligible&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="n">meets_resource_test</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;meets_ssi_resource_test&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="n">eligible</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;is_ssi_eligible_individual&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate_divide</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">record_calculation_start</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>     <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_name</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">332</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode_to_str</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">489</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span>     <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span>     <span class="c1"># If no result, use the default value and cache it</span>
<span class="g g-Whitespace">    </span><span class="mi">494</span>     <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">495</span>         <span class="c1"># Check if the variable has a previously defined value</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">732</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/ssi_amount_if_eligible.py:16,</span> in <span class="ni">ssi_amount_if_eligible.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="k">def</span> <span class="nf">formula</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>     <span class="n">ssi</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">gov</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">ssi</span><span class="o">.</span><span class="n">amount</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="k">return</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>         <span class="n">where</span><span class="p">(</span>
<span class="ne">---&gt; </span><span class="mi">16</span>             <span class="n">person</span><span class="p">(</span><span class="s2">&quot;ssi_claim_is_joint&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">),</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>             <span class="n">ssi</span><span class="o">.</span><span class="n">couple</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span>             <span class="n">ssi</span><span class="o">.</span><span class="n">individual</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span>         <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>         <span class="o">*</span> <span class="n">MONTHS_IN_YEAR</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:134,</span> in <span class="ni">Population.__call__</span><span class="nt">(self, variable_name, period, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate_divide</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">**</span><span class="n">calculate_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>     <span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:330,</span> in <span class="ni">Simulation.calculate</span><span class="nt">(self, variable_name, period, map_to, decode_enums)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">record_calculation_start</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>     <span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_name</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">330</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">EnumArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode_enums</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">332</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode_to_str</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:491,</span> in <span class="ni">Simulation._calculate</span><span class="nt">(self, variable_name, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">489</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_cycle</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">491</span>     <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_formula</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span>     <span class="c1"># If no result, use the default value and cache it</span>
<span class="g g-Whitespace">    </span><span class="mi">494</span>     <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">495</span>         <span class="c1"># Check if the variable has a previously defined value</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:734,</span> in <span class="ni">Simulation._run_formula</span><span class="nt">(self, variable, population, period)</span>
<span class="g g-Whitespace">    </span><span class="mi">732</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">734</span>     <span class="n">array</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters_at</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">736</span> <span class="k">return</span> <span class="n">array</span>

<span class="nn">File ~/work/policyengine-us/policyengine-us/policyengine_us/variables/gov/ssa/ssi/ssi_claim_is_joint.py:12,</span> in <span class="ni">ssi_claim_is_joint.formula</span><span class="nt">(person, period, parameters)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="k">def</span> <span class="nf">formula</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="n">eligible</span> <span class="o">=</span> <span class="n">person</span><span class="p">(</span><span class="s2">&quot;is_ssi_aged_blind_disabled&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">12</span>     <span class="n">both_eligible</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">marital_unit</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eligible</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>     <span class="n">income_is_deemed</span> <span class="o">=</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>         <span class="n">person</span><span class="p">(</span><span class="s2">&quot;ssi_income_deemed_from_ineligible_spouse&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span>     <span class="k">return</span> <span class="n">both_eligible</span> <span class="o">|</span> <span class="n">income_is_deemed</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/projectors/projector.py:28,</span> in <span class="ni">Projector.__getattr__.&lt;locals&gt;.projector_function</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="k">def</span> <span class="nf">projector_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">reference_attr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">28</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_and_bubble_up</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/projectors/projector.py:37,</span> in <span class="ni">Projector.transform_and_bubble_up</span><span class="nt">(self, result)</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span> <span class="k">def</span> <span class="nf">transform_and_bubble_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">37</span>     <span class="n">transformed_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span>         <span class="k">return</span> <span class="n">transformed_result</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/projectors/entity_to_person_projector.py:19,</span> in <span class="ni">EntityToPersonProjector.transform</span><span class="nt">(self, result)</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayLike</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">19</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_entity</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/group_population.py:335,</span> in <span class="ni">GroupPopulation.project</span><span class="nt">(self, array, role)</span>
<span class="g g-Whitespace">    </span><span class="mi">334</span> <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="n">Role</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayLike</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">335</span>     <span class="bp">self</span><span class="o">.</span><span class="n">check_array_compatible_with_entity</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">336</span>     <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">check_role_validity</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">337</span>     <span class="k">if</span> <span class="n">role</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/populations/population.py:60,</span> in <span class="ni">Population.check_array_compatible_with_entity</span><span class="nt">(self, array)</span>
<span class="g g-Whitespace">     </span><span class="mi">58</span> <span class="k">def</span> <span class="nf">check_array_compatible_with_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span>     <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">60</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">61</span>             <span class="s2">&quot;Input </span><span class="si">{}</span><span class="s2"> is not a valid value for the entity </span><span class="si">{}</span><span class="s2"> (size = </span><span class="si">{}</span><span class="s2"> != </span><span class="si">{}</span><span class="s2"> = count)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">62</span>                 <span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span>             <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span>         <span class="p">)</span>

<span class="ne">ValueError</span>: Input [0. 0. 0. ... 0. 0. 0.] is not a valid value for the entity marital_unit (size = 3001 != 3003 = count)
</pre></div>
</div>
</div>
</div>
<p>Total marginal tax rates range from below -50% to above 50%.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="s2">&quot;employment_income&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mtr&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;children&quot;</span><span class="p">,</span>
    <span class="n">animation_frame</span><span class="o">=</span><span class="s2">&quot;adults&quot;</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">LABELS</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Marginal tax rate for a Massachusetts household&quot;</span><span class="p">,</span>
    <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">COLOR_MAP</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">xaxis_tickformat</span><span class="o">=</span><span class="s2">&quot;$,&quot;</span><span class="p">,</span>
    <span class="n">yaxis_tickformat</span><span class="o">=</span><span class="s2">&quot;.1%&quot;</span><span class="p">,</span>
    <span class="n">yaxis_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">xaxis_gridcolor</span><span class="o">=</span><span class="n">LIGHT_GRAY</span><span class="p">,</span>
    <span class="n">yaxis_gridcolor</span><span class="o">=</span><span class="n">LIGHT_GRAY</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/418c5a33676919d03140d51808b9804244334759d5cd8a44a9e44355160814ff.png" src="../../../_images/418c5a33676919d03140d51808b9804244334759d5cd8a44a9e44355160814ff.png" />
</div>
</div>
<section id="other-situations">
<h3>Other situations<a class="headerlink" href="#other-situations" title="Permalink to this heading">#</a></h3>
<p>A single person who is age 65 and holds less than $2,000 in assets will be eligible for additional tax exemptions and federal Supplemental Security Income (SSI).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">IndividualSim</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2022</span><span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">add_person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">65</span><span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">add_tax_unit</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;tax_unit&quot;</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">],</span> <span class="n">premium_tax_credit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">add_spm_unit</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;spmu&quot;</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">])</span>
<span class="n">sim</span><span class="o">.</span><span class="n">add_household</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;head&quot;</span><span class="p">],</span> <span class="n">state_code</span><span class="o">=</span><span class="s2">&quot;MA&quot;</span><span class="p">)</span>

<span class="n">sim</span><span class="o">.</span><span class="n">vary</span><span class="p">(</span><span class="s2">&quot;employment_income&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100_000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">employment_income</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="s2">&quot;employment_income&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">spm_unit_net_income</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="s2">&quot;spm_unit_net_income&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
<span class="n">mtr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sim</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span>
    <span class="s2">&quot;spm_unit_net_income&quot;</span><span class="p">,</span> <span class="s2">&quot;employment_income&quot;</span><span class="p">,</span> <span class="n">wrt_target</span><span class="o">=</span><span class="s2">&quot;head&quot;</span>
<span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="n">employment_income</span><span class="o">=</span><span class="n">employment_income</span><span class="p">,</span>
        <span class="n">spm_unit_net_income</span><span class="o">=</span><span class="n">spm_unit_net_income</span><span class="p">,</span>
        <span class="n">mtr</span><span class="o">=</span><span class="n">mtr</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="s2">&quot;employment_income&quot;</span><span class="p">,</span>
    <span class="s2">&quot;spm_unit_net_income&quot;</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">LABELS</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Net income for a single person aged 65 in Massachusetts&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">xaxis_tickformat</span><span class="o">=</span><span class="s2">&quot;$,&quot;</span><span class="p">,</span>
    <span class="n">yaxis_tickformat</span><span class="o">=</span><span class="s2">&quot;$,&quot;</span><span class="p">,</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">xaxis_gridcolor</span><span class="o">=</span><span class="n">LIGHT_GRAY</span><span class="p">,</span>
    <span class="n">yaxis_gridcolor</span><span class="o">=</span><span class="n">LIGHT_GRAY</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/55b9ea074e31889ae48a66a6a26f52a2b29df2dfe593fb62f764499903162041.png" src="../../../_images/55b9ea074e31889ae48a66a6a26f52a2b29df2dfe593fb62f764499903162041.png" />
</div>
</div>
<p>This single 65-year-old faces marginal tax rates between 57 and 80 percent when they earn between $1,100 and $21,300.
Earnings beyond that, up to $100,000, are subject to marginal tax rates between 22 and 35 percent, except for a cliff when they lose SNAP eligibility at $25,700 earnings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="s2">&quot;employment_income&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mtr&quot;</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">LABELS</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Marginal tax rate for a single person aged 65 in Massachusetts&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">xaxis_tickformat</span><span class="o">=</span><span class="s2">&quot;$,&quot;</span><span class="p">,</span>
    <span class="n">yaxis_tickformat</span><span class="o">=</span><span class="s2">&quot;.1%&quot;</span><span class="p">,</span>
    <span class="n">yaxis_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">xaxis_gridcolor</span><span class="o">=</span><span class="n">LIGHT_GRAY</span><span class="p">,</span>
    <span class="n">yaxis_gridcolor</span><span class="o">=</span><span class="n">LIGHT_GRAY</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/87fd92695d7098725bc61b8315ef28249f44601041bae89b61d761c2eb82ded8.png" src="../../../_images/87fd92695d7098725bc61b8315ef28249f44601041bae89b61d761c2eb82ded8.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./gov/states/ma"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="tax/income/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Massachusetts income tax</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Massachusetts</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Massachusetts tax and benefit system</a><ul>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#other-situations">Other situations</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script src="../../../_static/scripts/furo.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    </body>
</html>